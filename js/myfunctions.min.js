//Testurl - Speichern
//http://www.schwitte.de/einsatzinfo/save_options.php?key=fCPXkFQagMTJNyk9qUza3KnZLeTEBR&uuid=no_id&tb_mail=aktivierung@schwitte.de&tb_receipient1=&tb_receipient2=&tb_receipient3=&tb_receipient4=&tb_receipient5=&tb_message=
//Testurl - Aktivierung
//http://localhost/einsatzinfo/activation.php?uuid=no_id

var url_send_mail = 'http://www.schwitte.de/einsatzinfo/send_mail.php';
var url_save_options = 'http://www.schwitte.de/einsatzinfo/save_options.php';
var url_get_infos = 'http://www.schwitte.de/einsatzinfo/get_infos.php';

// var url_send_mail = 'http://localhost/einsatzinfo/send_mail.php';
// var url_save_options = 'http://localhost/einsatzinfo/save_options.php';
// var url_get_infos = 'http://localhost/einsatzinfo/get_infos.php';

var delay;
var h_cancel_send_mail = "false";
var h_secretkey = "fCPXkFQagMTJNyk9qUza3KnZLeTEBR";
var g_uuid = "no_id";
var g_status_mail;
var g_status_user_activated;
var g_status_connection;

//Texte
//{no_message} -> versendet keine Nachricht mehr
//{restore}    -> Loescht lokale Eintraege und DB Eintraege

$(document).ready(function(){
   $.mobile.defaultPageTransition = 'none';
   $.mobile.defaultDialogTransition = 'none';
   $.mobile.useFastClick = true;
    
   // When the browser is ready...
   $(function() {
  
      // Setup form validation on the #register-form element
      $("#register-form").validate({
    
         // Specify the validation rules
         rules: {
            tb_mail: "required",
            tb_receipient1: "required",
            tb_message: "required",
            range_delay: "required"
         },
        
         // Specify the validation error messages
         messages: {
            tb_mail: "Bitte eine gültige Mailadresse angeben",
            tb_receipient1: "Bitte eine gültige Mailadresse angeben",
            tb_receipient2: "Bitte eine gültige Mailadresse angeben",
            tb_receipient3: "Bitte eine gültige Mailadresse angeben",
            tb_receipient4: "Bitte eine gültige Mailadresse angeben",
            tb_receipient5: "Bitte eine gültige Mailadresse angeben",
            tb_message: "Dies ist ein Pflichtfeld",
            range_delay: "Dies ist ein Pflichtfeld"
         },
        
         submitHandler: function(form) {
            form.submit();
        }
      });
   });
   
   // //Laden der Optionen - Für Debug mit Browser
   // load_options("no_id");  
});

function onDeviceReady() {
   //Hole/erzeuge id (per Plugin)
   window.plugins.uniqueDeviceID.get(uuid_success, uuid_fail);
};

function uuid_success(uuid)
{
   console.log(uuid);
   //Speichern der ID
   g_uuid = uuid;

   $("#dyn_info_id").html('ID='+g_uuid).trigger('create');  
   
   if(checkConnection() == 1)
   {
       show_message("Es besteht keine Verbindung zum Internet");
       $("#dyn_info_connection").html('Connection='+g_status_connection).trigger('create'); 
       return;
   }
   
   $("#dyn_info_connection").html('Connection='+g_status_connection).trigger('create');  
   
   //Laden der Optionen
   load_options(uuid);  
};

function uuid_fail(uuid)
{
   $("#dyn_info_id").html('ID='+g_uuid).trigger('create'); 
};

function onDeviceResume() {
   //So wird der Mailversand auch ausgeführt, wenn die App im Hintergrund weiterlief und nicht geschlossen wurde
   
   //Zum Startbildschirm
   location.href=("#Main") 
   //Neu Laden
   window.location.reload();
};

function load_options(uuid){
   if(checkConnection() == 1)
   {
     show_message("Es besteht keine Verbindung zum Internet");
     return;
   }

   //Laden den gespeicherten Optionen
   $.ajax({
      type: 'GET',
      url: url_get_infos,
      contentType: "application/json",
      dataType: 'jsonp',
      data: { uuid : uuid, key : h_secretkey },
      crossDomain: true,
      success: function(res) {
         console.log(res);
         //Set userdata
         document.getElementById('tb_receipient1').value=res.tb_receipient1;
         document.getElementById('tb_receipient2').value=res.tb_receipient2;
         document.getElementById('tb_receipient3').value=res.tb_receipient3;
         document.getElementById('tb_receipient4').value=res.tb_receipient4;
         document.getElementById('tb_receipient5').value=res.tb_receipient5;
         document.getElementById('tb_message').value=res.tb_message;
         if(res.range_delay != "")
         {
            document.getElementById('range_delay').value=res.range_delay;
         }
         document.getElementById('tb_mail').value=res.tb_mail;
         
         //Pruefen, ob Mindestinformationen vorhanden sind  
         if(check_settings() == 0)
         {
            //Mindestinformationen sind vorhanden
            
            //Setze description
            var h_description = '';
            h_description += '<p>Die Nachricht <br><u><i>';
            h_description += document.getElementById("tb_message").value.replace(/\n/g, '<br />');
            h_description += '</u></i><br> wird an folgende Mail-Empänger versendet:</p>';
            h_description += '<ul>';
            if(document.getElementById("tb_receipient1").value != "")
                h_description += '<li>'+document.getElementById("tb_receipient1").value+'</li>';
            if(document.getElementById("tb_receipient2").value != "")
                h_description += '<li>'+document.getElementById("tb_receipient2").value+'</li>';
            if(document.getElementById("tb_receipient3").value != "")
                h_description += '<li>'+document.getElementById("tb_receipient3").value+'</li>';
            if(document.getElementById("tb_receipient4").value != "")
                h_description += '<li>'+document.getElementById("tb_receipient4").value+'</li>';
            if(document.getElementById("tb_receipient5").value != "")
                h_description += '<li>'+document.getElementById("tb_receipient5").value+'</li>';
            h_description += '</ul>';
            $("#description").html(h_description).trigger('create'); 
            //Ende Setze description
            
            //Timer setzen
            delay = document.getElementById("range_delay").value;
            //Timer starten
            countdown();        
            
            //Buttontext ändern in 'Mailversand abbrechen'
            set_buttontext("cancel.png", "Benachrichtigung<br>abbrechen");               
         }
         else
         {
            //Direkt die Optionen anzeigen
            location.href=("#Options") 
            //Abbruch der Initialisierung
            g_status_mail = "inactive";
            
            set_buttontext("option.png", "Einstellungen<br>notwendig");
            document.getElementById('lb_counter').innerHTML="Einstellungen<br>notwendig";
         }
         
         g_status_user_activated = res.activated;
         var h_status = '';
         if(res.activated == "true")
         {
             h_status = "Aktiviert";
         }
         else if(res.activated == "false")
         {
            h_status = "Nicht aktiviert";
            set_buttontext("option.png", "Aktivierung<br>notwendig");
            document.getElementById('lb_counter').innerHTML="Aktivierung notwendig";
            //Direkt die Optionen anzeigen
            location.href=("#Options");
            //Abbruch der Initialisierung
            g_status_mail = "inactive";
            
            show_message("Bitte aktivieren Sie Ihre Mailadresse.");
         }
         else
         {
            h_status = res.activated;
         }
         
         h_status = "Status="+h_status;
         $("#dyn_info_status").html(h_status).trigger('create'); 
      },
      error: function(e) {
         console.log("load_options - error");
         h_status = 'Status=Error';
         $("#dyn_info_status").html(h_status).trigger('create'); 
         show_message("error"+e);
      },
      done: function(e) {
         console.log("load_options - complete");
      }
   });
}



function check_settings(){
   if(document.getElementById("range_delay").value == '')
   {
       document.getElementById("range_delay").value = 15;
   }
   if(document.getElementById("range_delay").value == '0')
   {
       document.getElementById("range_delay").value = 15;
   }

   var retval = 0;
   //1. Voraussetzung: Mindestens ein Empfaenger
   if(document.getElementById("tb_receipient1").value == "" && 
   document.getElementById("tb_receipient2").value == "" && 
   document.getElementById("tb_receipient3").value == "" && 
   document.getElementById("tb_receipient4").value == "" &&
   document.getElementById("tb_receipient5").value == "")
       retval = 1;
   //2. Voraussetzung: Nachricht muss angegeben werden
   if(document.getElementById("tb_message").value == "")
       retval = 1;
   //3. Voraussetzung: Verzoegerung muss angegeben werden
   if(document.getElementById("range_delay").value == "")
       retval = 1;
   //4. Voraussetzung: Mailadresse muss angegeben werden
   if(document.getElementById("tb_mail").value == "")
       retval = 1;
   
   if(retval == 1)
   {
      show_message("Bitte nehmen Sie die Einstellungen vor. Mindestens 'Eigene Mail', 'Mail-Emfänger' und 'Nachricht'");
   }
   
   return retval;
}

function set_buttontext(img, text){
   var h_html = '';
   h_html += '<center><table>';
   h_html += '<tr>';
   h_html += '<td><b><img src="images/'+img+'" width="48" height="48"></b></td>';
   h_html += '<td><center>'+text+'</center></td>';
   h_html += '<td><img src="images/'+img+'" width="48" height="48"></td>';
   h_html += '</tr>';
   h_html += '<table></center>';
   document.getElementById("bt_cancel_mail").innerHTML=h_html;
}



function save_options(){

   //Speichern der Optionen
   if(check_settings() == 1)
   {
      return;
   }

   if(checkConnection() == 1)
   {
      show_message("Es besteht keine Verbindung zum Internet");
      return;
   }    

   $.ajax({
     type: 'GET',
     url: url_save_options,
     contentType: "application/json",
     dataType: 'jsonp',
     async: false,
     data: { tb_receipient1 : document.getElementById("tb_receipient1").value, tb_receipient2 : document.getElementById("tb_receipient2").value, tb_receipient3 : document.getElementById("tb_receipient3").value, tb_receipient4 : document.getElementById("tb_receipient4").value, tb_receipient5 : document.getElementById("tb_receipient5").value, tb_message : document.getElementById("tb_message").value.replace('<br />', /\n/g), tb_mail : document.getElementById("tb_mail").value, range_delay : document.getElementById("range_delay").value, uuid : g_uuid, key : h_secretkey },
     crossDomain: true,
     success: function(res) {
        console.log(res);
     
        if(res.is_new_mail == "1")
        {
           show_message("Ihnen wurde eine Aktivierungsmail zugesendet. Bitte rufen Sie den Aktivierungslink auf um Ihre Mailadresse zu aktivieren");
        }
        else
        {
           show_message("Einstellungen gespeichert. Beim nächsten Start der App wird automatisch an den/die Empfänger eine Nachricht gesendet.");
        }
     },
     error: function(e) {
        console.log("save_options - error");
        show_message("Fehler beim Speichern der Daten");
     }
   });
}

function countdown(){
   if(g_status_mail == "inactive")
      return;

   if(h_cancel_send_mail == "false")
   {
      //Button 'Abbrechen' wurde nicht angeklickt
      //Herunterzaehlen des Countdown
      delay--;
      document.getElementById('lb_counter').innerHTML="Die Benachrichtigung wird in "+delay+" Sekunden versendet.";
      if(delay>0)
      {
          setTimeout('countdown()',1000);
      }
      else 
      {
         //Versenden der Mails
         send_email();
      }
   }
   else
   {
     //Es wurde abgebrochen
   }
} ;

function send_email(){
    
   if(document.getElementById("tb_message").value == "{no_message}")
   {
      document.getElementById('lb_counter').innerHTML="no_message";
      return;
   }
    
   //Holen der Mailempfaenger
   var h_receipient;
   var senden_erfolgreich = 0;
   h_receipient = "";
   h_receipient = add_receipient(h_receipient, "tb_receipient1");
   h_receipient = add_receipient(h_receipient, "tb_receipient2");
   h_receipient = add_receipient(h_receipient, "tb_receipient3");
   h_receipient = add_receipient(h_receipient, "tb_receipient4");
   h_receipient = add_receipient(h_receipient, "tb_receipient5");
   $.ajax({
      type: 'GET',
      url: url_send_mail,
      contentType: "application/json",
      dataType: 'jsonp',
      async: false,
      data: { tb_message : document.getElementById("tb_message").value.replace(/\n/g, '<br />'), receipient : h_receipient, uuid : g_uuid, key : h_secretkey },
      crossDomain: true,
      success: function(res) {
         console.log(res);
         document.getElementById('lb_counter').innerHTML="Die Benachrichtigung wurde versendet.";
         set_buttontext("check.png", "Versendet")
         g_status_mail = "inactive";
         senden_erfolgreich = 1;
      },
      error: function(e) {
         senden_erfolgreich = 0;
         console.log("send_email - error");
      }
   });
};

function add_receipient(h_receipient, h_tb_receipient)
{
   if(document.getElementById(h_tb_receipient).value != "")
   {
      if(h_receipient != "")
      { 
         h_receipient += ","+document.getElementById(h_tb_receipient).value;
      }
      else
      {
         h_receipient = document.getElementById(h_tb_receipient).value;
      }
   }
   return h_receipient
}

function cancel_send_mail(){
   if(g_status_mail == "inactive")
      return;

   if(h_cancel_send_mail == "false")   
   {
      set_buttontext("mail.png", "Benachrichtigung<br>versenden");
      document.getElementById('lb_counter').innerHTML="Die Benachrichtigung wurde abgebrochen.";
      h_cancel_send_mail = "true";
   }
   else
   {
      h_cancel_send_mail = "false"
      delay = document.getElementById("range_delay").value;
      set_buttontext("cancel.png", "Benachrichtigung<br>abbrechen");
      countdown();
   }
} 

function checkConnection() {
   var networkState;
   try
   {
      networkState = navigator.connection.type;
      var states = {};
      states[Connection.UNKNOWN]  = 'Unknown connection';
      states[Connection.ETHERNET] = 'Ethernet connection';
      states[Connection.WIFI]     = 'WiFi connection';
      states[Connection.CELL_2G]  = 'Cell 2G connection';
      states[Connection.CELL_3G]  = 'Cell 3G connection';
      states[Connection.CELL_4G]  = 'Cell 4G connection';
      states[Connection.CELL]     = 'Cell generic connection';
      states[Connection.NONE]     = 'No network connection';
      g_status_connection = states[networkState];
      
      if(g_status_connection == 'No network connection')
      {
         return 1;
      }
      else
      {
         return 0;
      }
   }
   catch(err)
   {
      g_status_connection = "error";
      return 1;
   }
}

function show_message(txt){
   try
   {
      navigator.notification.alert(txt,function() {}, 'Einsatzinfo', 'Ok');
   }
   catch(err)
   {
      alert(txt);
   }
}