var url_send_mail = 'http://www.schwitte.de/einsatzinfo/send_mail.php';
var delay;
var h_cancel_send_mail = "false";


// Aktuell nicht notwendig, da kein Plugin erforderlich
// document.addEventListener('deviceready', function () {
    // //Ready for Cordova
// }, false);   

$(document).ready(function(){
    $.mobile.defaultPageTransition = 'none';
    $.mobile.defaultDialogTransition = 'none';
    $.mobile.useFastClick = true;
    //Laden der Optionen
    load_options();     
    //Pruefen, ob Mindestinformationen vorhanden sind    
    if(check_settings() == 1)
    {
        alert("Bitte geben Sie die Mindestinformationen an.");
        document.getElementById("bt_cancel_mail").innerHTML="Abbruch der Benachrichtigung nicht m&ouml;glich.<br>Mindestinformationen fehlen.";
        //Direkt die Optionen anzeigen
        location.href=("#Options")
        //Abbruch der Initialisierung
        return;
    }
    else
    {
        //Buttontext ändern in 'Mailversand abbrechen'
        document.getElementById("bt_cancel_mail").innerHTML='<img src="images/cancel.png" width="48" height="48"><font size="6">Benachrichtigung abbrechen</font><img src="images/cancel.png" width="48" height="48">';
    }
    
    set_description();
    
    //Timer setzen
    delay = document.getElementById("range_delay").value;
    //Timer starten
    countdown();
});

function onDeviceResume() {
window.location.reload();
}

function check_settings(){
    //1. Voraussetzung: Mindestens ein Empfaenger
    if(document.getElementById("tb_receipient1").value == "" && 
    document.getElementById("tb_receipient2").value == "" && 
    document.getElementById("tb_receipient3").value == "" && 
    document.getElementById("tb_receipient4").value == "" &&
    document.getElementById("tb_receipient5").value == "")
        return 1
    //2. Voraussetzung: Nachricht muss angegeben werden
    if(document.getElementById("tb_message").value == "")
        return 1
}

function set_description(){
    var h_description = '';
    h_description += '<p>Die Nachricht <br><u><i>'
    h_description += document.getElementById("tb_message").value.replace(/\n/g, '<br />');
    h_description += '</u></i><br> wird an folgende Mail-Empänger versendet:</p>';
    h_description += '<p>'+document.getElementById("tb_receipient1").value+'</p>';
    h_description += '<p>'+document.getElementById("tb_receipient2").value+'</p>';
    h_description += '<p>'+document.getElementById("tb_receipient3").value+'</p>';
    h_description += '<p>'+document.getElementById("tb_receipient4").value+'</p>';
    h_description += '<p>'+document.getElementById("tb_receipient5").value+'</p>';
    $("#description").html(h_description).trigger('create');  
}

function load_options(){
    //Laden den gespeicherten Optionen
    load_item("tb_receipient1");
    load_item("tb_receipient2");
    load_item("tb_receipient3");
    load_item("tb_receipient4");
    load_item("tb_receipient5");
    load_item("tb_message");
    load_item("range_delay");
}

function load_item(itemname){
    document.getElementById(itemname).value = window.localStorage.getItem(itemname);
}

function save_options(){
    //Speichern der Optionen
    if(check_settings() == 1)
    {
        //Pruefen, ob Mindestinformationen vorhanden sind    
        $( "#popupSettingsMissing" ).popup( "open" ); //Wurde in index.html deklariert
        return;
    }

    save_item("tb_receipient1");
    save_item("tb_receipient2");
    save_item("tb_receipient3");
    save_item("tb_receipient4");
    save_item("tb_receipient5");
    save_item("tb_message");
    save_item("range_delay");
    $( "#popupSettingsSaved" ).popup( "open" ); //Wurde in index.html deklariert
    
    
$("input[type=range]").val(60).slider("refresh");
    
}

function save_item(itemname){
    var tmp_value = document.getElementById(itemname).value;
    window.localStorage.setItem(itemname, tmp_value);
}

function countdown(){
    if(h_cancel_send_mail == "false")
    {
        //Button 'Abbrechen' wurde nicht angeklickt
        //Herunterzaehlen des Countdown
        delay--;
        document.getElementById('lb_counter').innerHTML="Die Benachrichtigung wird in "+delay+" versendet.";
        if(delay>0)
        {
            setTimeout('countdown()',1000);
        }
        else 
        {
            //Versenden der Mails
            send_email();
        }
    }
    else
    {
      //Es wurde abgebrochen
    }
} ;

function send_email(){
    try
    {
        //Holen der Mailempfaenger
        var h_receipient;
        h_receipient = "";
        h_receipient = add_receipient(h_receipient, "tb_receipient1");
        h_receipient = add_receipient(h_receipient, "tb_receipient2");
        h_receipient = add_receipient(h_receipient, "tb_receipient3");
        h_receipient = add_receipient(h_receipient, "tb_receipient4");
        h_receipient = add_receipient(h_receipient, "tb_receipient5");
            $.ajax({
                type: 'GET',
                url: url_send_mail,
                contentType: "application/json",
                dataType: 'jsonp',
                data: { tb_message : document.getElementById("tb_message").value.replace(/\n/g, '<br />'), receipient : h_receipient, key : "fCPXkFQagMTJNyk9qUza3KnZLeTEBR"},
                crossDomain: true,
                success: function(res) {
                     console.log('Erfolgreich');
                     document.getElementById('lb_counter').innerHTML="Die Benachrichtigung wurde versendet.";
                     document.getElementById("bt_cancel_mail").innerHTML="Abbruch der Benachrichtigung nicht mehr m&ouml;glich";
                     return false;
                },
                error: function(e) {
                    document.getElementById('lb_counter').innerHTML="Fehler beim Versenden.";
                    document.getElementById("bt_cancel_mail").innerHTML="Abbruch der Benachrichtigung nicht m&ouml;glich";
                    console.log("Fehler");
                }
            });
    }
    catch(err)
    {
        txt="There was an error on this page.\n\n";
        txt+="Error description: " + err.message + "\n\n";
        alert(txt);
    }
};

function add_receipient(h_receipient, h_tb_receipient)
{
    if(document.getElementById(h_tb_receipient).value != "")
    {
        if(h_receipient != "")
        { 
            h_receipient += ","+document.getElementById(h_tb_receipient).value;
        }
        else
        {
            h_receipient = document.getElementById(h_tb_receipient).value;
        }
    }
    return h_receipient
}

function cancel_send_mail(){
   if(h_cancel_send_mail == "false")   
   {
      document.getElementById("bt_cancel_mail").innerHTML='<img src="images/mail.png" width="48" height="48"><font size="6">Benachrichtigung versenden</font><img src="images/mail.png" width="48" height="48">';   
       document.getElementById('lb_counter').innerHTML="Die Benachrichtigung wurde abgebrochen.";
      h_cancel_send_mail = "true";
   }
   else
   {
      h_cancel_send_mail = "false"
      delay = document.getElementById("range_delay").value;
      document.getElementById("bt_cancel_mail").innerHTML='<img src="images/cancel.png" width="48" height="48"><font size="6">Benachrichtigung abbrechen</font><img src="images/cancel.png" width="48" height="48">';
      countdown();
   }
} 