var url_send_mail = 'http://www.schwitte.de/einsatzinfo/send_mail.php';
var delay;
var h_cancel_send_mail = "false";

document.addEventListener('deviceready', function () {
    if(check_settings() == 1)
    {
        $( "#popupSettingsMissing" ).popup( "open" );
        location.href=("#Options")
        return;
    }
}, false);   

$(document).ready(function(){
    if(check_settings() == 1)
    {
        // $( "#popupSettingsMissing" ).popup( "open" );
        // location.href=("#Options")
        return;
    }
   
    load_options();
    delay = document.getElementById("range_delay").value;
    countdown();
    document.addEventListener('deviceready', function () {

    }, false);   
});

function check_settings(){
    if(document.getElementById("tb_receipient1").value == "" && 
    document.getElementById("tb_receipient2").value == "" && 
    document.getElementById("tb_receipient3").value == "" && 
    document.getElementById("tb_receipient4").value == "" &&
    document.getElementById("tb_receipient5").value == "")
        return 1
    if(document.getElementById("tb_message").value == "")
        return 1

}

function load_options(){
    load_item("tb_receipient1");
    load_item("tb_receipient2");
    load_item("tb_receipient3");
    load_item("tb_receipient4");
    load_item("tb_receipient5");
    load_item("tb_message");
    load_item("range_delay");
}

function load_item(itemname){
    document.getElementById(itemname).value = window.localStorage.getItem(itemname);
}

function save_options(){

    if(check_settings() == 1)
    {
        $( "#popupSettingsMissing" ).popup( "open" );
        return;
    }

    save_item("tb_receipient1");
    save_item("tb_receipient2");
    save_item("tb_receipient3");
    save_item("tb_receipient4");
    save_item("tb_receipient5");
    save_item("tb_message");
    save_item("range_delay");
    $( "#popupSettingsSaved" ).popup( "open" );
}

function save_item(itemname){
    var tmp_value = document.getElementById(itemname).value;
    window.localStorage.setItem(itemname, tmp_value);
}

function send_email(){
    try
    {
        //Holen der Mailempfaenger
            $.ajax({
                type: 'GET',
                url: url_send_mail,
                contentType: "application/json",
                dataType: 'jsonp',
                data: { tb_message : document.getElementById("tb_message").value, chat_user : document.getElementById("tb_message").value},
                crossDomain: true,
                success: function(res) {
                     console.log('Erfolgreich');
                     document.getElementById('lb_counter').innerHTML="Die Benachrichtigung wurde versendet.";
                     return false;
                },
                error: function(e) {
                    console.log("Fehler");
                }
            });
    }
    catch(err)
    {
        txt="There was an error on this page.\n\n";
        txt+="Error description: " + err.message + "\n\n";
        alert(txt);
    }
};



function countdown(){
    if(h_cancel_send_mail == "false")
    {
        delay--;
        document.getElementById('lb_counter').innerHTML="Die Benachrichtigung wird in "+delay+" versendet.";
        if(delay>0)
        {
            setTimeout('countdown()',1000);
        }
        else 
        {
            send_email();
        }
    }
    else
    {
        document.getElementById('lb_counter').innerHTML="Die Benachrichtigung wurde abgebrochen.";
    }
} ;



function cancel_send_mail(){
    h_cancel_send_mail = "true";
} 
