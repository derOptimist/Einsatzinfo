var url_send_mail = 'http://www.schwitte.de/einsatzinfo/send_mail.php';
var delay;
var h_cancel_send_mail = "false";

document.addEventListener('deviceready', function () {
    //Ready for Cordova
}, false);   

$(document).ready(function(){
    if(check_settings() == 1)
    {
        alert("Bitte geben Sie die Mindestinformationen an.");
        change_bt_cancel_mail('hidden', 'test');
        location.href=("#Options")
        return;
    }
 
    load_options();
    delay = document.getElementById("range_delay").value;
    countdown();
    document.addEventListener('deviceready', function () {

    }, false);   
});

function change_bt_cancel_mail(h_visibility, h_text){
//document.getElementById('bt_cancel_mail').style.visibility = h_visibility;
document.getElementById('bt_cancel_mail').value = h_text;
// document.getElementById('bt_cancel_mail').style.visibility = 'visible';
}

function check_settings(){
    if(document.getElementById("tb_receipient1").value == "" && 
    document.getElementById("tb_receipient2").value == "" && 
    document.getElementById("tb_receipient3").value == "" && 
    document.getElementById("tb_receipient4").value == "" &&
    document.getElementById("tb_receipient5").value == "")
        return 1
    if(document.getElementById("tb_message").value == "")
        return 1

}

function load_options(){
    load_item("tb_receipient1");
    load_item("tb_receipient2");
    load_item("tb_receipient3");
    load_item("tb_receipient4");
    load_item("tb_receipient5");
    load_item("tb_message");
    load_item("range_delay");
}

function load_item(itemname){
    document.getElementById(itemname).value = window.localStorage.getItem(itemname);
}

function save_options(){

    if(check_settings() == 1)
    {
        $( "#popupSettingsMissing" ).popup( "open" );
        return;
    }

    save_item("tb_receipient1");
    save_item("tb_receipient2");
    save_item("tb_receipient3");
    save_item("tb_receipient4");
    save_item("tb_receipient5");
    save_item("tb_message");
    save_item("range_delay");
    $( "#popupSettingsSaved" ).popup( "open" );
}

function save_item(itemname){
    var tmp_value = document.getElementById(itemname).value;
    window.localStorage.setItem(itemname, tmp_value);
}

function send_email(){
    try
    {
        //Holen der Mailempfaenger
        
        var h_receipient;
        h_receipient = "";
        h_receipient = add_receipient(h_receipient, "tb_receipient1");
        h_receipient = add_receipient(h_receipient, "tb_receipient2");
        h_receipient = add_receipient(h_receipient, "tb_receipient3");
        h_receipient = add_receipient(h_receipient, "tb_receipient4");
        h_receipient = add_receipient(h_receipient, "tb_receipient5");
        alert(h_receipient);
            $.ajax({
                type: 'GET',
                url: url_send_mail,
                contentType: "application/json",
                dataType: 'jsonp',
                data: { tb_message : document.getElementById("tb_message").value, receipient : h_receipient},
                crossDomain: true,
                success: function(res) {
                     console.log('Erfolgreich');
                     document.getElementById('lb_counter').innerHTML="Die Benachrichtigung wurde versendet.";
                     return false;
                },
                error: function(e) {
                    console.log("Fehler");
                }
            });
    }
    catch(err)
    {
        txt="There was an error on this page.\n\n";
        txt+="Error description: " + err.message + "\n\n";
        alert(txt);
    }
};

function add_receipient(h_receipient, h_tb_receipient)
{
    if(document.getElementById(h_tb_receipient).value != "")
    {
        if(h_receipient != "")
        { 
            h_receipient += ","+document.getElementById(h_tb_receipient).value;
        }
        else
        {
            h_receipient = document.getElementById(h_tb_receipient).value;
        }
    }
    return h_receipient
}


function countdown(){
    if(h_cancel_send_mail == "false")
    {
        delay--;
        document.getElementById('lb_counter').innerHTML="Die Benachrichtigung wird in "+delay+" versendet.";
        if(delay>0)
        {
            setTimeout('countdown()',1000);
        }
        else 
        {
            send_email();
        }
    }
    else
    {
        document.getElementById('lb_counter').innerHTML="Die Benachrichtigung wurde abgebrochen.";
    }
} ;



function cancel_send_mail(){
    h_cancel_send_mail = "true";
} 
