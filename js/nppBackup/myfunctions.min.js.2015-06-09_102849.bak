//Testurl http://www.schwitte.de/einsatzinfo/save_options.php?key=fCPXkFQagMTJNyk9qUza3KnZLeTEBR&uuid=no_id&tb_mail=aktivierung@schwitte.de&tb_receipient1=&tb_receipient2=&tb_receipient3=&tb_receipient4=&tb_receipient5=&tb_message=

// var url_send_mail = 'http://www.schwitte.de/einsatzinfo/send_mail.php';
// var url_save_options = 'http://www.schwitte.de/einsatzinfo/save_options.php';
// var url_get_infos = 'http://www.schwitte.de/einsatzinfo/get_infos.php';

var url_send_mail = 'http://localhost/einsatzinfo/send_mail.php';
var url_save_options = 'http://localhost/einsatzinfo/save_options.php';
var url_get_infos = 'http://localhost/einsatzinfo/get_infos.php';

var delay;
var h_cancel_send_mail = "false";
var h_store_pref = "Einsatzinfo_"
var h_secretkey = "fCPXkFQagMTJNyk9qUza3KnZLeTEBR";
var g_uuid = "no_id";
var h_status_user = "no_status";
var h_status_mail;



$(document).ready(function(){

    $.mobile.defaultPageTransition = 'none';
    $.mobile.defaultDialogTransition = 'none';
    $.mobile.useFastClick = true;
    //Laden der Optionen
    load_options();     
    //Pruefen, ob Mindestinformationen vorhanden sind    
    if(check_settings() == 1)
    {
        alert("Bitte geben Sie die Mindestinformationen an.");
        // document.getElementById("bt_cancel_mail").innerHTML="Abbruch der Benachrichtigung nicht m&ouml;glich.<br>Mindestinformationen fehlen.";
        set_buttontext("option.png", "Einstellungen<br>notwendig")
        //Direkt die Optionen anzeigen
        location.href=("#Options")
        //Abbruch der Initialisierung
        h_status_mail = "inactive";
        return;
    }
    else
    {
        //Buttontext ändern in 'Mailversand abbrechen'
        //document.getElementById("bt_cancel_mail").innerHTML='<img src="images/cancel.png" width="48" height="48"><font size="6">Benachrichtigung abbrechen</font><img src="images/cancel.png" width="48" height="48">';
        set_buttontext("cancel.png", "Benachrichtigung<br>abbrechen");
    }

    set_description();

    if(get_info_status() == 1)
    {
        //Nicht aktiviert
        return;
    }

    //Timer setzen
    delay = document.getElementById("range_delay").value;
    //Timer starten
    countdown();
});

function onDeviceReady() {
//Hole/erzeuge id (per Plugin)
window.plugins.uniqueDeviceID.get(uuid_success, uuid_fail);
};

function uuid_success(uuid)
{
    console.log(uuid);
    //Speichern der ID
    g_uuid = uuid;
    set_info_id();
};

function uuid_fail(uuid)
{
    alert("uuid_fail");
};

function onDeviceResume() {
//So wird der Mailversand auch ausgeführt, wenn die App im Hintergrund weiterlief und nicht geschlossen wurde
window.location.reload();
};

function check_settings(){
    //1. Voraussetzung: Mindestens ein Empfaenger
    if(document.getElementById("tb_receipient1").value == "" && 
    document.getElementById("tb_receipient2").value == "" && 
    document.getElementById("tb_receipient3").value == "" && 
    document.getElementById("tb_receipient4").value == "" &&
    document.getElementById("tb_receipient5").value == "")
        return 1
    //2. Voraussetzung: Nachricht muss angegeben werden
    if(document.getElementById("tb_message").value == "")
        return 1
    //3. Voraussetzung: Verzoegerung muss angegeben werden
    if(document.getElementById("range_delay").value == "")
        return 1
    //4. Voraussetzung: Mailadresse muss angegeben werden
    if(document.getElementById("tb_mail").value == "")
        return 1
}

function set_description(){
    var h_description = '';
    h_description += '<p>Die Nachricht <br><u><i>';
    h_description += document.getElementById("tb_message").value.replace(/\n/g, '<br />');
    h_description += '</u></i><br> wird an folgende Mail-Empänger versendet:</p>';
    h_description += '<ul>';
    if(document.getElementById("tb_receipient1").value != "")
        h_description += '<li>'+document.getElementById("tb_receipient1").value+'</li>';
    if(document.getElementById("tb_receipient2").value != "")
        h_description += '<li>'+document.getElementById("tb_receipient2").value+'</li>';
    if(document.getElementById("tb_receipient3").value != "")
        h_description += '<li>'+document.getElementById("tb_receipient3").value+'</li>';
    if(document.getElementById("tb_receipient4").value != "")
        h_description += '<li>'+document.getElementById("tb_receipient4").value+'</li>';
    if(document.getElementById("tb_receipient5").value != "")
        h_description += '<li>'+document.getElementById("tb_receipient5").value+'</li>';
    h_description += '</ul>';
    $("#description").html(h_description).trigger('create');  
}

function set_info_id(){
    var h_info = '';
    h_info += 'ID='+g_uuid;
    $("#dyn_info").html(h_info).trigger('create');  
}

function get_info_status(){
    var h_status = '';
    $.ajax({
        type: 'GET',
        url: url_get_infos,
        contentType: "application/json",
        dataType: 'jsonp',
        data: { uuid : g_uuid, key : h_secretkey },
        crossDomain: true,
        success: function(res) {
             console.log('get_info_status - Erfolgreich');

             h_status = "Status="+res.status;
             $("#dyn_info_status").html(h_status).trigger('create');

            if(res.status != "Aktiviert")
            {
                alert("Bitte aktivieren Sie Ihre Mailadresse.");
                // document.getElementById("bt_cancel_mail").innerHTML="Abbruch der Benachrichtigung nicht m&ouml;glich.<br>Mindestinformationen fehlen.";
                set_buttontext("option.png", "Aktivierung<br>notwendig");
                document.getElementById('lb_counter').innerHTML="Aktivierung notwendig.";
                //Direkt die Optionen anzeigen
                location.href=("#Options");
                //Abbruch der Initialisierung
                h_status_mail = "inactive";
                return 1;
            }
        },
        error: function(e) {
            console.log("get_info_status - Fehler");
            h_status = 'Status=Error';
             $("#dyn_info_status").html(h_status).trigger('create'); 
        }
    });
     

}

function set_buttontext(img, text){
   var h_html = '';
   h_html += '<center><table>';
   h_html += '<tr>';
   h_html += '<td><b><img src="images/'+img+'" width="48" height="48"></b></td>';
   h_html += '<td><center>'+text+'</center></td>';
   h_html += '<td><img src="images/'+img+'" width="48" height="48"></td>';
   h_html += '</tr>';
   h_html += '<table></center>';
   document.getElementById("bt_cancel_mail").innerHTML=h_html;
}

function load_options(){
    //Laden den gespeicherten Optionen
    load_item("tb_receipient1");
    load_item("tb_receipient2");
    load_item("tb_receipient3");
    load_item("tb_receipient4");
    load_item("tb_receipient5");
    load_item("tb_message");
    load_item("range_delay");
    load_item("tb_mail");
}

function load_item(itemname){
    document.getElementById(itemname).value = window.localStorage.getItem(h_store_pref+itemname);
}

function save_options(){
    //Speichern der Optionen
    if(check_settings() == 1)
    {
        //Pruefen, ob Mindestinformationen vorhanden sind    
        $( "#popupSettingsMissing" ).popup( "open" ); //Wurde in index.html deklariert
        return;
    }

    save_item("tb_receipient1");
    save_item("tb_receipient2");
    save_item("tb_receipient3");
    save_item("tb_receipient4");
    save_item("tb_receipient5");
    save_item("tb_message");
    save_item("range_delay");
    save_item("tb_mail");
    $( "#popupSettingsSaved" ).popup( "open" ); //Wurde in index.html deklariert
    
    
    $.ajax({
        type: 'GET',
        url: url_save_options,
        contentType: "application/json",
        dataType: 'jsonp',
        data: { tb_receipient1 : document.getElementById("tb_receipient1").value, tb_receipient2 : document.getElementById("tb_receipient2").value, tb_receipient3 : document.getElementById("tb_receipient3").value, tb_receipient4 : document.getElementById("tb_receipient4").value, tb_receipient5 : document.getElementById("tb_receipient5").value, tb_message : document.getElementById("tb_message").value.replace(/\n/g, '<br />'), tb_mail : document.getElementById("tb_mail").value, uuid : g_uuid, key : h_secretkey },
        crossDomain: true,
        success: function(res) {
             console.log('Erfolgreich');
        },
        error: function(e) {
            console.log("Fehler");
        }
    });

    if(document.getElementById("tb_message").value == "{restore}")
    {
        window.localStorage.setItem(h_store_pref+"tb_message", "");
        window.localStorage.setItem(h_store_pref+"tb_receipient1", "");
        window.localStorage.setItem(h_store_pref+"tb_receipient2", "");
        window.localStorage.setItem(h_store_pref+"tb_receipient3", "");
        window.localStorage.setItem(h_store_pref+"tb_receipient4", "");
        window.localStorage.setItem(h_store_pref+"tb_receipient5", "");
        window.localStorage.setItem(h_store_pref+"range_delay", "");
        return;
    }
    
}

function save_item(itemname){
    var tmp_value = document.getElementById(itemname).value;
    window.localStorage.setItem(h_store_pref+itemname, tmp_value);
}

function countdown(){
   if(h_status_mail == "inactive")
      return;

    if(h_cancel_send_mail == "false")
    {
        //Button 'Abbrechen' wurde nicht angeklickt
        //Herunterzaehlen des Countdown
        delay--;
        document.getElementById('lb_counter').innerHTML="Die Benachrichtigung wird in "+delay+" Sekunden versendet.";
        if(delay>0)
        {
            setTimeout('countdown()',1000);
        }
        else 
        {
            //Versenden der Mails
            send_email();
        }
    }
    else
    {
      //Es wurde abgebrochen
    }
} ;

function send_email(){
    try
    {
       if(document.getElementById("tb_message").value == "{no_message}")
       {
          document.getElementById('lb_counter').innerHTML="no_message";
          return;
       }
    
    
        //Holen der Mailempfaenger
        var h_receipient;
        h_receipient = "";
        h_receipient = add_receipient(h_receipient, "tb_receipient1");
        h_receipient = add_receipient(h_receipient, "tb_receipient2");
        h_receipient = add_receipient(h_receipient, "tb_receipient3");
        h_receipient = add_receipient(h_receipient, "tb_receipient4");
        h_receipient = add_receipient(h_receipient, "tb_receipient5");
        $.ajax({
            type: 'GET',
            url: url_send_mail,
            contentType: "application/json",
            dataType: 'jsonp',
            data: { tb_message : document.getElementById("tb_message").value.replace(/\n/g, '<br />'), receipient : h_receipient, uuid : g_uuid, key : h_secretkey },
            crossDomain: true,
            success: function(res) {
                 console.log('Erfolgreich');
                 document.getElementById('lb_counter').innerHTML="Die Benachrichtigung wurde versendet.";
                 // document.getElementById("bt_cancel_mail").innerHTML="Abbruch der Benachrichtigung nicht mehr m&ouml;glich";
                 set_buttontext("check.png", "Versendet")
                 h_status_mail = "inactive";
                 return false;
            },
            error: function(e) {
                document.getElementById('lb_counter').innerHTML="Fehler beim Versenden.";
                // document.getElementById("bt_cancel_mail").innerHTML="Abbruch der Benachrichtigung nicht m&ouml;glich";
                set_buttontext("alert.png", "Fehler")
                console.log("Fehler");
            }
        });
    }
    catch(err)
    {
        txt="There was an error on this page.\n\n";
        txt+="Error description: " + err.message + "\n\n";
        alert(txt);
    }
};

function add_receipient(h_receipient, h_tb_receipient)
{
    if(document.getElementById(h_tb_receipient).value != "")
    {
        if(h_receipient != "")
        { 
            h_receipient += ","+document.getElementById(h_tb_receipient).value;
        }
        else
        {
            h_receipient = document.getElementById(h_tb_receipient).value;
        }
    }
    return h_receipient
}

function cancel_send_mail(){
   if(h_status_mail == "inactive")
      return;

   if(h_cancel_send_mail == "false")   
   {
      //document.getElementById("bt_cancel_mail").innerHTML='<img src="images/mail.png" width="48" height="48"><div><font size="6">Benachrichtigung<br>versenden</font></div><img src="images/mail.png" width="48" height="48">';   
      set_buttontext("mail.png", "Benachrichtigung<br>versenden");
      document.getElementById('lb_counter').innerHTML="Die Benachrichtigung wurde abgebrochen.";
      h_cancel_send_mail = "true";
   }
   else
   {
      h_cancel_send_mail = "false"
      delay = document.getElementById("range_delay").value;
      //document.getElementById("bt_cancel_mail").innerHTML='<img src="images/cancel.png" width="48" height="48"><div><font size="6">Benachrichtigung<br>abbrechen</font></div><img src="images/cancel.png" width="48" height="48">';
      set_buttontext("cancel.png", "Benachrichtigung<br>abbrechen");
      countdown();
   }
} 



