//Testurl - Speichern
//http://www.schwitte.de/einsatzinfo/save_options.php?key=fCPXkFQagMTJNyk9qUza3KnZLeTEBR&uuid=no_id&tb_mail=aktivierung@schwitte.de&tb_receipient1=&tb_receipient2=&tb_receipient3=&tb_receipient4=&tb_receipient5=&tb_message=
//Testurl - Aktivierung
//http://localhost/einsatzinfo/activation.php?uuid=no_id

var url_send_mail = 'http://www.schwitte.de/einsatzinfo/send_mail.php';
var url_save_options = 'http://www.schwitte.de/einsatzinfo/save_options.php';
var url_get_infos = 'http://www.schwitte.de/einsatzinfo/get_inf_os.php';

// var url_send_mail = 'http://localhost/einsatzinfo/send_mail.php';
// var url_save_options = 'http://localhost/einsatzinfo/save_options.php';
// var url_get_infos = 'http://localhost/einsatzinfo/get_infos.php';

var delay;
var h_cancel_send_mail = "false";
var h_secretkey = "fCPXkFQagMTJNyk9qUza3KnZLeTEBR";
var g_uuid = "no_id";
var h_status_user = "no_status";
var h_status_mail;

//Texte
//{no_message} -> versendet keine Nachricht mehr
//{restore}    -> Loescht lokale Eintraege und DB Eintraege



$(document).ready(function(){
    $.mobile.defaultPageTransition = 'none';
    $.mobile.defaultDialogTransition = 'none';
    $.mobile.useFastClick = true;



    
    //Laden der Optionen
    load_options();     
});

function onDeviceReady() {
    //Hole/erzeuge id (per Plugin)
    window.plugins.uniqueDeviceID.get(uuid_success, uuid_fail);
};

function uuid_success(uuid)
{
    console.log(uuid);
    //Speichern der ID
    g_uuid = uuid;
    set_info_id();
};

function uuid_fail(uuid)
{
    alert("uuid_fail");
};

function onDeviceResume() {
    //So wird der Mailversand auch ausgeführt, wenn die App im Hintergrund weiterlief und nicht geschlossen wurde
    window.location.reload();
};

function check_settings(){
    if(document.getElementById("range_delay").value == '')
    {
        document.getElementById("range_delay").value = 15;
    }
    if(document.getElementById("range_delay").value == '0')
    {
        document.getElementById("range_delay").value = 15;
    }

    var retval = 0;
    //1. Voraussetzung: Mindestens ein Empfaenger
    if(document.getElementById("tb_receipient1").value == "" && 
    document.getElementById("tb_receipient2").value == "" && 
    document.getElementById("tb_receipient3").value == "" && 
    document.getElementById("tb_receipient4").value == "" &&
    document.getElementById("tb_receipient5").value == "")
        retval = 1;
    //2. Voraussetzung: Nachricht muss angegeben werden
    if(document.getElementById("tb_message").value == "")
        retval = 1;
    //3. Voraussetzung: Verzoegerung muss angegeben werden
    if(document.getElementById("range_delay").value == "")
        retval = 1;
    //4. Voraussetzung: Mailadresse muss angegeben werden
    if(document.getElementById("tb_mail").value == "")
        retval = 1;
    
    if(retval == 1)
    {   
        //Direkt die Optionen anzeigen
        location.href=("#Options") 
        //Abbruch der Initialisierung
        h_status_mail = "inactive";
        
        set_buttontext("option.png", "Einstellungen<br>notwendig");
        document.getElementById('lb_counter').innerHTML="Einstellungen<br>notwendig";
        //Pruefen, ob Mindestinformationen vorhanden sind    
        $( "#popupSettingsMissing" ).popup( "open" ); //Wurde in index.html deklariert
    }
    else
    {
        //Buttontext ändern in 'Mailversand abbrechen'
        set_buttontext("cancel.png", "Benachrichtigung<br>abbrechen");
    }
    
    return retval;
}

function set_description(){
    var h_description = '';
    h_description += '<p>Die Nachricht <br><u><i>';
    h_description += document.getElementById("tb_message").value.replace(/\n/g, '<br />');
    h_description += '</u></i><br> wird an folgende Mail-Empänger versendet:</p>';
    h_description += '<ul>';
    if(document.getElementById("tb_receipient1").value != "")
        h_description += '<li>'+document.getElementById("tb_receipient1").value+'</li>';
    if(document.getElementById("tb_receipient2").value != "")
        h_description += '<li>'+document.getElementById("tb_receipient2").value+'</li>';
    if(document.getElementById("tb_receipient3").value != "")
        h_description += '<li>'+document.getElementById("tb_receipient3").value+'</li>';
    if(document.getElementById("tb_receipient4").value != "")
        h_description += '<li>'+document.getElementById("tb_receipient4").value+'</li>';
    if(document.getElementById("tb_receipient5").value != "")
        h_description += '<li>'+document.getElementById("tb_receipient5").value+'</li>';
    h_description += '</ul>';
    $("#description").html(h_description).trigger('create');  
}

function set_status(activated){
    var h_status = '';
    if(activated == "true")
    {
        h_status = "Aktiviert";
    }
    else if(activated == "false")
    {
        h_status = "Nicht aktiviert";
        set_buttontext("option.png", "Aktivierung<br>notwendig");
        document.getElementById('lb_counter').innerHTML="Aktivierung notwendig";
        //Direkt die Optionen anzeigen
        location.href=("#Options");
        //Abbruch der Initialisierung
        h_status_mail = "inactive";
        try
        {
            $( "#popupActivation" ).popup( "open" ); //Wurde in index.html deklariert
        }
        catch(err)
        {
            alert("Bitte aktivieren Sie Ihre Mailadresse.");
        }
    }
    else
    {
        h_status = activated;
    }
    
    h_status = "Status="+h_status;
    $("#dyn_info_status").html(h_status).trigger('create'); 
}

function set_info_id(){
    var h_info = '';
    h_info += 'ID='+g_uuid;
    $("#dyn_info").html(h_info).trigger('create');  
}

function set_buttontext(img, text){
   var h_html = '';
   h_html += '<center><table>';
   h_html += '<tr>';
   h_html += '<td><b><img src="images/'+img+'" width="48" height="48"></b></td>';
   h_html += '<td><center>'+text+'</center></td>';
   h_html += '<td><img src="images/'+img+'" width="48" height="48"></td>';
   h_html += '</tr>';
   h_html += '<table></center>';
   document.getElementById("bt_cancel_mail").innerHTML=h_html;
}


function load_options(){
    // $.mobile.loading('show');
    //Laden den gespeicherten Optionen
    var h_status = '';
    var h_json_done;
    h_json_done = 0;
    $.getJSON({
        type: 'GET',
        url: url_get_infos,
        contentType: "application/json",
        dataType: 'json',
        data: { uuid : g_uuid, key : h_secretkey },
        crossDomain: true,
        success: function(res) {
             console.log(res);
             h_json_done = 1;
             //Set userdata
             document.getElementById('tb_receipient1').value=res.tb_receipient1;
             document.getElementById('tb_receipient2').value=res.tb_receipient2;
             document.getElementById('tb_receipient3').value=res.tb_receipient3;
             document.getElementById('tb_receipient4').value=res.tb_receipient4;
             document.getElementById('tb_receipient5').value=res.tb_receipient5;
             document.getElementById('tb_message').value=res.tb_message;
             if(res.range_delay != "")
             {
               document.getElementById('range_delay').value=res.range_delay;
             }
             document.getElementById('tb_mail').value=res.tb_mail;
             
             //Pruefen, ob Mindestinformationen vorhanden sind  
  
             check_settings();
             
            set_status(res.activated);
             
            set_description();

            //Timer setzen
            delay = document.getElementById("range_delay").value;
            //Timer starten
            countdown();
        },
        error: function(e) {
            console.log("load_options - error");
            h_status = 'Status=Error';
             $("#dyn_info_status").html(h_status).trigger('create'); 
             alert("error");
        },
        always: function(e) {
            console.log("load_options - complete");
            h_status = 'Status=Error';
             $("#dyn_info_status").html(h_status).trigger('create'); 
             alert("complete");
        }
    });

}

function save_options(){
    //Speichern der Optionen
    if(check_settings() == 1)
    {
        return;
    }
    
    var speichern_erfolgreich;
    speichern_erfolgreich = 0;
    $.ajax({
        type: 'GET',
        url: url_save_options,
        contentType: "application/json",
        dataType: 'jsonp',
        async: false,
        data: { tb_receipient1 : document.getElementById("tb_receipient1").value, tb_receipient2 : document.getElementById("tb_receipient2").value, tb_receipient3 : document.getElementById("tb_receipient3").value, tb_receipient4 : document.getElementById("tb_receipient4").value, tb_receipient5 : document.getElementById("tb_receipient5").value, tb_message : document.getElementById("tb_message").value.replace('<br />', /\n/g), tb_mail : document.getElementById("tb_mail").value, range_delay : document.getElementById("range_delay").value, uuid : g_uuid, key : h_secretkey },
        crossDomain: true,
        success: function(res) {
            console.log(res);
      
            
            try
            {
                $( "#popupSettingsSaved" ).popup( "open" ); //Wurde in index.html deklariert
            }
            catch(err)
            {
                alert("Einstellungen gespeichert. Beim n&auml;chsten Start der App wird automatisch an den/die Empf&auml;nger eine Nachricht gesendet.");
            }
             
        },
        error: function(e) {
            console.log("save_options - error");
            alert("Fehler beim Speichern der Daten");
        }
    });
}

function countdown(){
   if(h_status_mail == "inactive")
      return;

    if(h_cancel_send_mail == "false")
    {
        //Button 'Abbrechen' wurde nicht angeklickt
        //Herunterzaehlen des Countdown
        delay--;
        document.getElementById('lb_counter').innerHTML="Die Benachrichtigung wird in "+delay+" Sekunden versendet.";
        if(delay>0)
        {
            setTimeout('countdown()',1000);
        }
        else 
        {
            //Versenden der Mails
            send_email();
        }
    }
    else
    {
      //Es wurde abgebrochen
    }
} ;

function send_email(){
    
       if(document.getElementById("tb_message").value == "{no_message}")
       {
          document.getElementById('lb_counter').innerHTML="no_message";
          return;
       }
    
    
        //Holen der Mailempfaenger
        var h_receipient;
        var senden_erfolgreich = 0;
        h_receipient = "";
        h_receipient = add_receipient(h_receipient, "tb_receipient1");
        h_receipient = add_receipient(h_receipient, "tb_receipient2");
        h_receipient = add_receipient(h_receipient, "tb_receipient3");
        h_receipient = add_receipient(h_receipient, "tb_receipient4");
        h_receipient = add_receipient(h_receipient, "tb_receipient5");
        $.ajax({
            type: 'GET',
            url: url_send_mail,
            contentType: "application/json",
            dataType: 'jsonp',
            async: false,
            data: { tb_message : document.getElementById("tb_message").value.replace(/\n/g, '<br />'), receipient : h_receipient, uuid : g_uuid, key : h_secretkey },
            crossDomain: true,
            success: function(res) {
                 console.log(res);
                 document.getElementById('lb_counter').innerHTML="Die Benachrichtigung wurde versendet.";
                 set_buttontext("check.png", "Versendet")
                 h_status_mail = "inactive";
                 senden_erfolgreich = 1;
                 alert("yipi");
            },
            error: function(e) {
                senden_erfolgreich = 0;
                console.log("send_email - error");
            }
        });
        
        alert("abfangen, falls Server nicht erreichbar");

    // if(senden_erfolgreich == 0)
    // {
        // // alert("Fehler beim Versenden der Mails!")
        // document.getElementById('lb_counter').innerHTML="Fehler beim Versenden.";
        // set_buttontext("alert.png", "Fehler")
    // }
    
};

function add_receipient(h_receipient, h_tb_receipient)
{
    if(document.getElementById(h_tb_receipient).value != "")
    {
        if(h_receipient != "")
        { 
            h_receipient += ","+document.getElementById(h_tb_receipient).value;
        }
        else
        {
            h_receipient = document.getElementById(h_tb_receipient).value;
        }
    }
    return h_receipient
}

function cancel_send_mail(){
   if(h_status_mail == "inactive")
      return;

   if(h_cancel_send_mail == "false")   
   {
      set_buttontext("mail.png", "Benachrichtigung<br>versenden");
      document.getElementById('lb_counter').innerHTML="Die Benachrichtigung wurde abgebrochen.";
      h_cancel_send_mail = "true";
   }
   else
   {
      h_cancel_send_mail = "false"
      delay = document.getElementById("range_delay").value;
      set_buttontext("cancel.png", "Benachrichtigung<br>abbrechen");
      countdown();
   }
} 



